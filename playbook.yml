---
- name: Deploy servers
  hosts: localhost
  gather_facts: no

  vars_files:
    - environments/{{ env }}/group_vars/rax.yml

  tasks:
    - name: Ensure servers
      rax:
        wait: yes
        wait_timeout: 600

        name: "{{ env }}-"
        group: "{{ env }}"
        auto_increment: yes
        count: "{{ server.count|default(1) }}"
        exact_count: yes

        image: "{{ server.image }}"
        flavor: "{{ server.flavor }}"
        region: "{{ server.region|default('IAD') }}"

        key_name: "{{ server.key }}"
      register: servers

    - name: Register new hosts
      add_host:
        hostname: "{{ item.name }}"
        ansible_host: "{{ item.rax_accessipv4 }}"
        groups: "{{ env }}"
      with_items: servers.success
      when: servers|changed

- name: Trust hosts
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Fetch host keys
      command: ssh-keyscan {{ hostvars[item].rax_accessipv4 }}
      register: host_ssh_keys
      with_items: groups[env]
      changed_when: false

    - name: Add host keys
      lineinfile:
        dest: ~/.ssh/known_hosts
        create: yes
        state: present
        line: "{{ item.1 }}"
      with_subelements:
        - host_ssh_keys.results
        - stdout_lines

- name: Bootstrap hosts
  hosts: "{{ env }}"
  gather_facts: no

  vars_files:
    - environments/{{ env }}/group_vars/rax.yml

  roles:
    - sigma.coreos-bootstrap

  tasks:
    - name: Install pip
      command: ~/bin/python -m ensurepip
      args:
        creates: ~/pypy/site-packages/pip

    - name: Install docker-py
      pip:
        name: docker-py
        state: latest

    - name: Write cloud-config
      become: yes
      template:
        src: templates/cloud-config.yml.j2
        dest: /usr/share/oem/cloud-config.yml

- name: Configure access
  hosts: "{{ env }}"
  gather_facts: yes

  tasks:
    - name: Ensure SSH keys
      authorized_key:
        user: "{{ ansible_ssh_user }}"
        key: https://github.com/{{ item }}.keys
      with_items:
        - dirn
        - jonafato

- name: Start services
  hosts: "{{ env }}"
  gather_facts: no

  tasks:
    - name: Ensure units directory
      file:
        path: ~/units
        state: directory
        owner: core
        group: core

    - name: Start services
      become: yes
      service:
        name: "{{ item }}.service"
        state: started
      with_items:
        - etcd
        - fleet

- name: Nginx
  hosts: "{{ env }}"
  gather_facts: no

  vars_files:
    - environments/{{ env }}/group_vars/services.yml

  tasks:
    - name: Upload Nginx service unit
      template:
        src: templates/nginx@.service.j2
        dest: ~/units/nginx@.service
      register: unit

    - block:
        - name: Stop Nginx
          run_once: yes
          command: fleetctl stop ~/units/nginx@.service
          ignore_errors: yes
          with_sequence: count="{{ nginx.count|default(1) }}"

        - name: Remove Nginx units
          run_once: yes
          command: fleetctl destroy ~/units/nginx@.service
          ignore_errors: yes
          with_sequence: count="{{ nginx.count|default(1) }}"

        - name: Register Nginx units
          run_once: yes
          command: fleetctl submit ~/units/nginx@.service

        - name: Start Nginx
          run_once: yes
          command: fleetctl start ~/units/nginx@{{ item }}.service
          with_sequence: count="{{ nginx.count|default(1) }}"
      # when: unit|changed

- name: Postgres
  hosts: "{{ env }}"
  gather_facts: no

  vars_files:
    - environments/{{ env }}/group_vars/services.yml

  tasks:
    - name: Upload Postgres service unit
      template:
        src: templates/postgres@.service.j2
        dest: ~/units/postgres@.service
      register: unit

    - block:
        - name: Stop Postgres
          run_once: yes
          command: fleetctl stop ~/units/postgres@.service
          ignore_errors: yes
          with_sequence: count="{{ postgres.count|default(1) }}"

        - name: Remove Postgres units
          run_once: yes
          command: fleetctl destroy ~/units/postgres@.service
          ignore_errors: yes
          with_sequence: count="{{ postgres.count|default(1) }}"

        - name: Register Postgres units
          run_once: yes
          command: fleetctl submit ~/units/postgres@.service

        - name: Start Postgres
          run_once: yes
          command: fleetctl start ~/units/postgres@{{ item }}.service
          with_sequence: count="{{ postgres.count|default(1) }}"
      # when: unit|changed

- name: Web
  hosts: "{{ env }}"
  gather_facts: no

  vars_files:
    - environments/{{ env }}/group_vars/services.yml

  tasks:
    - name: Upload web service unit
      template:
        src: templates/web@.service.j2
        dest: ~/units/web@.service
      register: unit

    - block:
        - name: Stop web
          run_once: yes
          command: fleetctl stop ~/units/web@.service
          ignore_errors: yes
          with_sequence: count="{{ web.count|default(1) }}" format=9%03d

        - name: Remove web units
          run_once: yes
          command: fleetctl destroy ~/units/web@.service
          ignore_errors: yes
          with_sequence: count="{{ web.count|default(1) }}" format=9%03d

        - name: Register web units
          run_once: yes
          command: fleetctl submit ~/units/web@.service

        - name: Start web
          run_once: yes
          command: fleetctl start ~/units/web@{{ item }}.service
          with_sequence: count="{{ web.count|default(1) }}" format=9%03d
      # when: unit|changed
